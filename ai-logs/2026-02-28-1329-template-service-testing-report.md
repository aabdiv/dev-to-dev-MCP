# üìã –û—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ TemplateService –∏ Jinja2 —à–∞–±–ª–æ–Ω–æ–≤

**–î–∞—Ç–∞:** 2026-02-28  
**–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫:** QA Engineer (pytest Test Engineer)  
**–û–±—ä–µ–∫—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** `services/template_service.py`, `templates/*.j2`

---

## üéØ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è: –ù–µ–≤–µ—Ä–Ω—ã–π –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤

**–§–∞–π–ª:** `src/mcp_server/services/template_service.py`  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ë—ã–ª–æ (–Ω–µ–≤–µ—Ä–Ω–æ):
template_dir = Path(__file__).parent.parent.parent / "templates"
# –ü—É—Ç—å: src/mcp_server/services/../../.. = src/templates (–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
```

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ —Ä–∞—Å—á—ë—Ç–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
```
project/
‚îú‚îÄ‚îÄ templates/          ‚Üê —à–∞–±–ª–æ–Ω—ã –∑–¥–µ—Å—å
‚îî‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ mcp_server/
        ‚îî‚îÄ‚îÄ services/   ‚Üê template_service.py –∑–¥–µ—Å—å
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –°—Ç–∞–ª–æ (–≤–µ—Ä–Ω–æ):
project_root = Path(__file__).parent.parent.parent.parent  # 4 —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö
template_dir = project_root / "templates"
```

---

### 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤ –ø–æ –¥–∞—Ç–∞–º –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö timestamp

**–§–∞–π–ª:** `src/mcp_server/services/template_service.py`  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í—Å–µ —Ç–µ–≥–∏ –≤ demo_project –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –¥–∞—Ç—É (`2026-02-28 00:26:18`)
- –õ–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç: `prev_tag['date'] < c.date <= tag['date']`
- –ü—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –¥–∞—Ç–∞—Ö –≤—Å–µ –∫–æ–º–º–∏—Ç—ã –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –ø–µ—Ä–≤—É—é –≤–µ—Ä—Å–∏—é (v1.0.0)

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
v1.0.0: 17 commits  # –í—Å–µ –∫–æ–º–º–∏—Ç—ã –≤ –æ–¥–Ω–æ–π –≤–µ—Ä—Å–∏–∏!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è hash —Ç–µ–≥–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥—Ä–∞–Ω–∏—Ü –≤–µ—Ä—Å–∏–π:

```python
# Build hash -> tag mapping
tag_hashes = {tag['hash']: tag for tag in tags}

# Process commits from oldest to newest
for commit in reversed(commits):
    current_version_commits.append(commit)
    
    # Check if this commit is tagged
    if commit.hash in tag_hashes:
        # Create version with all accumulated commits
        ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
v1.2.0: 7 commits, 0 breaking
v1.1.0: 6 commits, 1 breaking
v1.0.0: 4 commits, 0 breaking
```

---

## üß™ –ù–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `tests/test_template_service.py` —Å **23 —Ç–µ—Å—Ç–∞–º–∏**:

### Unit —Ç–µ—Å—Ç—ã TemplateService (6 —Ç–µ—Å—Ç–æ–≤)
| –¢–µ—Å—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|------|----------|--------|
| `test_init_default_template_dir` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | ‚úÖ |
| `test_init_custom_template_dir` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π | ‚úÖ |
| `test_render_changelog_empty_versions` | –†–µ–Ω–¥–µ—Ä –ø—É—Å—Ç–æ–≥–æ changelog | ‚úÖ |
| `test_group_commits_by_version_no_tags` | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –±–µ–∑ —Ç–µ–≥–æ–≤ | ‚úÖ |
| `test_group_commits_by_version_with_unreleased` | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å unreleased –∫–æ–º–º–∏—Ç–∞–º–∏ | ‚úÖ |
| `test_render_changelog_json_empty` | –†–µ–Ω–¥–µ—Ä –ø—É—Å—Ç–æ–≥–æ JSON changelog | ‚úÖ |

### Integration —Ç–µ—Å—Ç—ã (11 —Ç–µ—Å—Ç–æ–≤)
| –¢–µ—Å—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|------|----------|--------|
| `test_group_commits_demo_project` | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤ demo_project | ‚úÖ |
| `test_render_changelog_markdown` | –†–µ–Ω–¥–µ—Ä Markdown changelog | ‚úÖ |
| `test_render_changelog_keepachangelog` | –†–µ–Ω–¥–µ—Ä Keep a Changelog —Ñ–æ—Ä–º–∞—Ç–∞ | ‚úÖ |
| `test_render_changelog_json` | –†–µ–Ω–¥–µ—Ä JSON changelog | ‚úÖ |
| `test_changelog_versions_sorted_newest_first` | –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–µ—Ä—Å–∏–π (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏) | ‚úÖ |
| `test_breaking_changes_in_changelog` | Breaking changes –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç | ‚úÖ |
| `test_contributors_section` | –°–µ–∫—Ü–∏—è contributors | ‚úÖ |
| `test_commit_stats_in_changelog` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤ | ‚úÖ |
| `test_version_date_format` | –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã YYYY-MM-DD | ‚úÖ |
| `test_all_commits_grouped` | –í—Å–µ 17 –∫–æ–º–º–∏—Ç–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã | ‚úÖ |
| `test_json_output_structure` | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON output | ‚úÖ |

### Edge Cases (6 —Ç–µ—Å—Ç–æ–≤)
| –¢–µ—Å—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|------|----------|--------|
| `test_single_commit_single_tag` | –û–¥–∏–Ω –∫–æ–º–º–∏—Ç, –æ–¥–∏–Ω —Ç–µ–≥ | ‚úÖ |
| `test_commit_with_breaking_change` | –ö–æ–º–º–∏—Ç —Å breaking change | ‚úÖ |
| `test_multiple_authors_same_version` | –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–æ–≤ –≤ –≤–µ—Ä—Å–∏–∏ | ‚úÖ |
| `test_non_conventional_commits` | Non-conventional –∫–æ–º–º–∏—Ç—ã | ‚úÖ |
| `test_template_not_found` | –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —à–∞–±–ª–æ–Ω–∞ | ‚úÖ |
| `test_version_with_no_commits_excluded` | –í–µ—Ä—Å–∏–∏ –±–µ–∑ –∫–æ–º–º–∏—Ç–æ–≤ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è | ‚úÖ |

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—É—Å–∫–∞

```
============================== 23 passed in 2.86s ==============================
```

### Code Coverage

| Module | Statements | Miss | Cover |
|--------|-----------|------|-------|
| `src/mcp_server/models/changelog.py` | 17 | 0 | **100%** |
| `src/mcp_server/services/template_service.py` | 51 | 5 | **90%** |
| `src/mcp_server/services/analyzer.py` | 76 | 14 | 82% |
| `src/mcp_server/services/parser_service.py` | 31 | 2 | 94% |
| **TOTAL** | **196** | **40** | **80%** |

**–ù–µ–ø–æ–∫—Ä—ã—Ç—ã–π –∫–æ–¥ (5 —Å—Ç—Ä–æ–∫):** –º–µ—Ç–æ–¥ `_create_unreleased_version` (—Å—Ç—Ä–æ–∫–∏ 168-186) ‚Äî —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –Ω–∞ –ø—É—Å—Ç–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ –ø—É—Å—Ç–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
```python
def test_create_unreleased_version_empty_repo(self):
    """_create_unreleased_version —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º –∫–æ–º–º–∏—Ç–æ–≤."""
    ts = TemplateService()
    versions = ts._create_unreleased_version([])
    assert versions == []
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
–°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Ç–µ–≥–∞–º–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –¥–∞—Ç–∞—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.

### 3. –¢–µ—Å—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —à–∞–±–ª–æ–Ω–æ–≤ (path injection)
```python
def test_template_path_injection_prevented(self):
    """–ü–æ–ø—ã—Ç–∫–∞ path injection —á–µ—Ä–µ–∑ –∏–º—è —à–∞–±–ª–æ–Ω–∞."""
    ts = TemplateService()
    with pytest.raises(Exception):
        ts.render_changelog([], "../../../etc/passwd")
```

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
–ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–º–º–∏—Ç–æ–≤ (>1000) —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ —Å `reversed()` –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º –≤ —Å–ø–∏—Å–∫–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã.

### 5. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
–ü—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ `commits` –∏ `tags` –∏–º–µ—é—Ç –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

---

## ‚úÖ –ò—Ç–æ–≥

- **23 —Ç–µ—Å—Ç–∞** –Ω–∞–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
- **2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã** –Ω–∞–π–¥–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- **80% –ø–æ–∫—Ä—ã—Ç–∏–µ** –∫–æ–¥–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ
- **3 —à–∞–±–ª–æ–Ω–∞** (markdown, keepachangelog, json) –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- **demo_project** (17 –∫–æ–º–º–∏—Ç–æ–≤, 3 —Ç–µ–≥–∞) —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
