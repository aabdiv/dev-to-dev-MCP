# 2026-02-27 — Исправление _is_wip в parser_service.py

**Статус:** ✅ Исправлено, 9/9 тестов прошли  
**Участники:** User (Team Lead), Тестировщик, Разработчик

---

## Проблема

**Критический баг:** `_is_wip` проверял всё сообщение, а не только начало заголовка.

**Симптом:**
```python
parse_commit("feat: add WIP tracking")  # → None ❌
```

**Причина:**
```python
# Старый код:
def _is_wip(message: str) -> bool:
    return any(pattern in message for pattern in WIP_PATTERNS)
# "WIP" в любом месте сообщения → None
```

---

## Исправление

**Новый код:**
```python
def _is_wip(message: str) -> bool:
    """
    Check if message is WIP.
    
    Only checks the beginning of the header, not the entire message.
    This prevents false positives like "feat: add WIP tracking" being treated as WIP.
    """
    header = message.split('\n')[0].strip().lower()
    return any(
        header.startswith(pattern.lower())
        for pattern in ["WIP:", "wip:", "draft:", "do not merge"]
    )
```

**Что изменилось:**
1. Извлекаем только заголовок (до первой `\n`)
2. Проверяем `startswith()` вместо `in`
3. Нормализуем к нижнему регистру

---

## Новый тест

Добавлен тест на edge case:

```python
def test_wip_in_description_not_wip(self):
    """WIP в описании — не WIP коммит."""
    result = parse_commit("feat: add WIP tracking feature")
    assert result is not None
    assert result.type == "feat"
    assert result.description == "add WIP tracking feature"
```

---

## Обновление старого теста

Убрано ложное срабатывание из `test_wip_returns_none`:

**Было:**
```python
wip_messages = [
    "WIP: working on feature",
    "feat: WIP implementation",  # ❌ Удалено
    ...
]
```

**Стало:**
```python
wip_messages = [
    "WIP: working on feature",
    "wip: draft implementation",
    "Draft: do not review yet",
    "DO NOT MERGE: needs review",
]
```

---

## Результаты тестов

```
============================== 9 passed in 0.02s ===============================

Name                                        Stmts   Miss  Cover   Missing
-------------------------------------------------------------------------
src/mcp_server/services/parser_service.py      29      0   100%
```

✅ **Все тесты прошли**  
✅ **Покрытие 100%**

---

## Итог

**parser_service.py готов к использованию:**
- ✅ Парсит все типы Conventional Commits
- ✅ Поддерживает scope: `feat(api):`
- ✅ Detect breaking changes: `feat!:`, `BREAKING CHANGE:`
- ✅ Игнорирует WIP по началу заголовка
- ✅ Не игнорирует "WIP" в описании

---

## Следующий шаг

**Итерация 2: analyzer.py**

После парсера создаём анализатор git-репозитория.
